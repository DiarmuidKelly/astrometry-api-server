name: PR Auto-Labeler

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  label-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Determine labels
        id: labels
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          LABELS=""

          # Version labels
          if [[ "$PR_TITLE" =~ ^\[MAJOR\] ]]; then
            LABELS="major"
          elif [[ "$PR_TITLE" =~ ^\[MINOR\] ]]; then
            LABELS="minor"
          elif [[ "$PR_TITLE" =~ ^\[PATCH\] ]]; then
            LABELS="patch"
          elif [[ "$PR_TITLE" =~ ^\[skip-release\] ]]; then
            LABELS="skip-release"
          fi

          # Conventional commit type labels
          if [[ "$PR_TITLE" =~ ^feat ]]; then
            LABELS="${LABELS:+$LABELS,}feature"
          elif [[ "$PR_TITLE" =~ ^fix ]]; then
            LABELS="${LABELS:+$LABELS,}bugfix"
          elif [[ "$PR_TITLE" =~ ^docs ]]; then
            LABELS="${LABELS:+$LABELS,}documentation"
          elif [[ "$PR_TITLE" =~ ^test ]]; then
            LABELS="${LABELS:+$LABELS,}testing"
          elif [[ "$PR_TITLE" =~ ^refactor ]]; then
            LABELS="${LABELS:+$LABELS,}refactoring"
          elif [[ "$PR_TITLE" =~ ^(ci|build) ]]; then
            LABELS="${LABELS:+$LABELS,}ci-cd"
          fi

          echo "labels=$LABELS" >> $GITHUB_OUTPUT

      - name: Create labels if they don't exist
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const labels = [
              { name: 'major', color: 'b60205', description: 'Major version bump (breaking changes)' },
              { name: 'minor', color: '0e8a16', description: 'Minor version bump (new features)' },
              { name: 'patch', color: '1d76db', description: 'Patch version bump (bug fixes)' },
              { name: 'skip-release', color: 'cccccc', description: 'Skip automatic release' },
              { name: 'feature', color: '0e8a16', description: 'New feature' },
              { name: 'bugfix', color: 'd73a4a', description: 'Bug fix' },
              { name: 'documentation', color: '0075ca', description: 'Documentation updates' },
              { name: 'testing', color: 'f9d0c4', description: 'Testing improvements' },
              { name: 'refactoring', color: 'fbca04', description: 'Code refactoring' },
              { name: 'ci-cd', color: '5319e7', description: 'CI/CD changes' }
            ];

            for (const label of labels) {
              try {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label.name,
                  color: label.color,
                  description: label.description
                });
                console.log(`Created label: ${label.name}`);
              } catch (error) {
                if (error.status === 422) {
                  console.log(`Label already exists: ${label.name}`);
                } else {
                  throw error;
                }
              }
            }

      - name: Apply labels
        if: steps.labels.outputs.labels != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const labels = '${{ steps.labels.outputs.labels }}'.split(',').filter(l => l);

            if (labels.length > 0) {
              await github.rest.issues.setLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: labels
              });
              console.log(`Applied labels: ${labels.join(', ')}`);
            }
