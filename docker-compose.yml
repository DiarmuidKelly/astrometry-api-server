services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: astrometry-api-server
    ports:
      - "${PORT:-8080}:8080"
    environment:
      - PORT=8080
      - ASTROMETRY_CONTAINER_NAME=astrometry-solver
    volumes:
      # Docker socket (REQUIRED for containerized deployment)
      # SECURITY WARNING: Grants root-equivalent access to host
      # See SECURITY.md for details and production alternatives
      - /var/run/docker.sock:/var/run/docker.sock

      # Mount astrometry index files (read-only)
      - ${ASTROMETRY_INDEX_PATH:-./astrometry-data}:/data/indexes:ro

      # Shared volume for file exchange with astrometry container
      - astrometry-shared:/shared-data

    restart: unless-stopped
    depends_on:
      - astrometry

    # Health check
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:8080/health",
        ]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M

  astrometry:
    image: diarmuidk/astrometry-dockerised-solver:latest
    container_name: astrometry-solver
    volumes:
      # Mount astrometry index files (read-only)
      - ${ASTROMETRY_INDEX_PATH:-./astrometry-data}:/usr/local/astrometry/data:ro

      # Shared volume for file exchange with API server
      - astrometry-shared:/shared-data

    # Keep container running
    command: tail -f /dev/null

    restart: unless-stopped

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 4G
        reservations:
          cpus: "1.0"
          memory: 2G

volumes:
  astrometry-shared:

# Usage:
# 1. Set environment variables or create .env file:
#    ASTROMETRY_INDEX_PATH=/path/to/your/indexes
#    PORT=8080
#
# 2. Build and start services:
#    docker compose up -d --build
#
# 3. Test the health endpoint:
#    curl http://localhost:8080/health
#
# 4. Test solving an image:
#    curl -X POST -F "image=@test.jpg" -F "scale_low=1" -F "scale_high=5" \
#         http://localhost:8080/solve
#
# 5. View logs:
#    docker compose logs -f api
#    docker compose logs -f astrometry
#
# 6. Stop the servers:
#    docker compose down
#
# Architecture:
# - API server uses docker exec to run solve-field in long-running astrometry container
# - Files exchanged via shared Docker volume
# - Docker socket required for containerized deployment
#
# SECURITY NOTE:
# - This setup requires docker socket access (root-equivalent access to host)
# - Suitable for local development and trusted internal networks
# - NOT suitable for public internet deployment without additional security layers
# - See SECURITY.md for production deployment recommendations
