services:
  api:
    build:
      context: ..
      dockerfile: astrometry-api-server/Dockerfile
    container_name: astrometry-api-server
    ports:
      - "${PORT:-8080}:8080"
    environment:
      - ASTROMETRY_INDEX_PATH=/data/indexes
      - PORT=8080
      - ASTROMETRY_CONTAINER_NAME=astrometry-solver
    volumes:
      # Mount Docker socket for docker exec commands
      - /var/run/docker.sock:/var/run/docker.sock

      # Mount astrometry index files (read-only)
      - ${ASTROMETRY_INDEX_PATH:-/home/diarmuid/code/astrometry-go-client/astrometry-data}:/data/indexes:ro

      # Shared volume for file exchange with astrometry container
      - astrometry-shared:/shared-data

    restart: unless-stopped
    depends_on:
      - astrometry

    # Health check
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:8080/health",
        ]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M

  astrometry:
    image: dm90/astrometry:latest
    container_name: astrometry-solver
    volumes:
      # Mount astrometry index files (read-only)
      - ${ASTROMETRY_INDEX_PATH:-/home/diarmuid/code/astrometry-go-client/astrometry-data}:/usr/local/astrometry/data:ro

      # Shared volume for file exchange with API server
      - astrometry-shared:/shared-data

    # Keep container running
    command: tail -f /dev/null

    restart: unless-stopped

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 4G
        reservations:
          cpus: "1.0"
          memory: 2G

volumes:
  astrometry-shared:
# Usage:
# 1. Set environment variables or create .env file:
#    ASTROMETRY_INDEX_PATH=/path/to/your/indexes
#    PORT=8080
#
# 2. Build and start both services:
#    docker compose up -d --build
#
# 3. Test the health endpoint:
#    curl http://localhost:8080/health
#
# 4. Test solving an image:
#    curl -X POST -F "image=@test.jpg" -F "scale_low=1" -F "scale_high=5" \
#         http://localhost:8080/solve
#
# 5. View logs:
#    docker compose logs -f api
#    docker compose logs -f astrometry
#
# 6. Stop the servers:
#    docker compose down
#
# Architecture: API server calls docker exec on the astrometry container.
# Files are exchanged via the shared Docker volume.
